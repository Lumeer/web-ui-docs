<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Lumeer Web UI documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">Lumeer Web UI documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search">
</div>
            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>PointData</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/view/perspectives/chart/visualizer/plot-maker/axis-draggable-plot-maker.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#clickedY">clickedY</a>
                                </li>
                                <li>
                                        <a href="#initialValue">initialValue</a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#initialY">initialY</a>
                                </li>
                                <li>
                                        <a href="#isCategory">isCategory</a>
                                </li>
                                <li>
                                        <a href="#lastValue">lastValue</a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#offset">offset</a>
                                </li>
                                <li>
                                        <a href="#traceIx">traceIx</a>
                                </li>
                                <li>
                                        <a href="#yScale">yScale</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="clickedY"></a>
                                        <span class="name"><b>clickedY</b><a href="#clickedY"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>clickedY:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="initialValue"></a>
                                        <span class="name"><b>initialValue</b><a href="#initialValue"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>initialValue:     <code>string | number</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>string | number</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="initialY"></a>
                                        <span class="name"><b>initialY</b><a href="#initialY"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>initialY:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="isCategory"></a>
                                        <span class="name"><b>isCategory</b><a href="#isCategory"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>isCategory:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="lastValue"></a>
                                        <span class="name"><b>lastValue</b><a href="#lastValue"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>lastValue:     <code>string | number</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>string | number</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="offset"></a>
                                        <span class="name"><b>offset</b><a href="#offset"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>offset:     <code>literal type</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>literal type</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="traceIx"></a>
                                        <span class="name"><b>traceIx</b><a href="#traceIx"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>traceIx:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="yScale"></a>
                                        <span class="name"><b>yScale</b><a href="#yScale"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>yScale:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {Layout} from &#x27;plotly.js&#x27;;
import {ChartAxisType} from &#x27;../../../../../core/store/charts/chart.model&#x27;;
import {DraggablePlotMaker} from &#x27;./draggable-plot-maker&#x27;;
import * as d3 from &#x27;d3&#x27;;

export abstract class AxisDraggablePlotMaker extends DraggablePlotMaker {
  public abstract getPoints(): any;

  public abstract getTraceIndexForPoint(point: any): number;

  public abstract getPointPosition(point: any, datum: any): {x: number; y: number};

  public abstract getPointNewY(point: any, datum: any, event: any): number;

  protected yAxis1Layout(): Partial&lt;Layout&gt; {
    const type &#x3D; ChartAxisType.Y1;
    if (this.config.axes[type] &amp;&amp; this.isAxisCategory(type)) {
      return {
        yaxis: {
          type: &#x27;category&#x27;,
          categoryarray: this.getYAxisCategories(type),
        },
      };
    }
    return {};
  }

  protected yAxis2Layout(): Partial&lt;Layout&gt; {
    const type &#x3D; ChartAxisType.Y2;

    if (this.config.axes[type]) {
      if (this.isAxisCategory(type)) {
        return {
          yaxis2: {
            overlaying: &#x27;y&#x27;,
            side: &#x27;right&#x27;,
            type: &#x27;category&#x27;,
            categoryarray: this.getYAxisCategories(type),
          },
        };
      }

      return {
        yaxis2: {
          overlaying: &#x27;y&#x27;,
          side: &#x27;right&#x27;,
        },
      };
    }
  }

  protected isAxisCategory(type: ChartAxisType): boolean {
    const axis &#x3D; this.config.axes[type];
    if (!axis) {
      return false;
    }
    for (const document of this.documents) {
      const value &#x3D; document.data[axis.attributeId];
      if (value &amp;&amp; !this.isNumeric(value)) {
        return true;
      }
    }

    return false;
  }

  protected getYAxisCategories(type: ChartAxisType): string[] {
    const axis &#x3D; this.config.axes[type];
    if (!axis) {
      return [];
    }

    return this.documents.reduce((values, document) &#x3D;&gt; {
      const value &#x3D; document.data[axis.attributeId];
      if (value &amp;&amp; !values.includes(value)) {
        values.push(value);
      }
      return values;
    }, []);
  }

  protected createYScale(traceIndex: number): (val: number) &#x3D;&gt; any {
    const yAxisElement &#x3D; this.getYAxisElementForTrace(traceIndex);
    if (yAxisElement.type &#x3D;&#x3D;&#x3D; &#x27;category&#x27;) {
      return this.createYScaleCategories(yAxisElement);
    }
    return this.createYScaleLinear(yAxisElement);
  }

  protected createYScaleLinear(yAxisElement: any): d3.scale.Linear&lt;number, number&gt; {
    return d3.scale
      .linear()
      .domain([this.getGridHeight(), 0])
      .range(yAxisElement.range);
  }

  protected createYScaleCategories(yAxisElement: any): (val: number) &#x3D;&gt; string {
    const yAxisMargin &#x3D; this.computeYMarginCategories(yAxisElement);
    const gridHeight &#x3D; this.getGridHeight();
    const categories &#x3D; yAxisElement._categories;
    const domainStep &#x3D; (gridHeight - 2 * yAxisMargin) / (categories.length - 1);
    const domainRange &#x3D; d3.range(yAxisMargin + domainStep / 2, gridHeight - yAxisMargin, domainStep);
    const domain &#x3D; domainRange.reverse();

    return value &#x3D;&gt; {
      for (let i &#x3D; 0; i &lt; domain.length; i++) {
        // TODO binary search
        if (value &gt; domain[i]) {
          return categories[i];
        }
      }
      return categories.length &gt; 0 ? categories[categories.length - 1] : null;
    };
  }

  protected computeYMarginCategories(yAxisElement: any): number {
    const downRange &#x3D; Math.abs(yAxisElement.range[0]);
    const upRange &#x3D; Math.abs(yAxisElement.range[1]);
    const range &#x3D; downRange + upRange;
    return (this.getGridHeight() / range) * downRange;
  }

  protected getGridHeight(): number {
    const element &#x3D; this.getLayoutElement();
    return element.height - element.margin.t - element.margin.b;
  }

  protected getAttributeIdForTrace(index: number): string {
    if (index &gt; 0 || !this.config.axes[ChartAxisType.Y1]) {
      return this.config.axes[ChartAxisType.Y2].attributeId;
    }
    return this.config.axes[ChartAxisType.Y1].attributeId;
  }

  protected getYAxisElementForTrace(index: number): any {
    if (index &gt; 0 || !this.config.axes[ChartAxisType.Y1]) {
      return this.getLayoutElement().yaxis2;
    }
    return this.getLayoutElement().yaxis;
  }

  protected getLayoutElement(): any {
    return this.element.nativeElement._fullLayout;
  }

  protected canDragPoints(): boolean {
    return this.config &amp;&amp; (!!this.config.axes[ChartAxisType.Y1] || !!this.config.axes[ChartAxisType.Y2]);
  }

  public initDrag() {
    this.destroyDrag();

    if (this.canDragPoints()) {
      this.getPoints().call(this.createDrag());
    }
  }

  private createDrag(): any {
    const plotMaker &#x3D; this;
    return d3.behavior
      .drag()
      .origin(function(datum: any) {
        const traceIx &#x3D; plotMaker.getTraceIndexForPoint(this);
        const yScale &#x3D; plotMaker.createYScale(traceIx);
        const initialValue &#x3D; plotMaker.getInitialValue(traceIx, datum.i);
        const lastValue &#x3D; initialValue;
        const isCategory &#x3D; plotMaker.isTraceCategory(traceIx);

        let pointData: PointData &#x3D; {traceIx, yScale, initialValue, lastValue, isCategory};

        if (datum.ct) {
          const initialY &#x3D; datum.ct[1];
          const event &#x3D; d3.event as MouseEvent;
          const offset &#x3D; plotMaker.getElementOffset(event.target as Element);
          const elementClickedY &#x3D; event.pageY - offset.top;
          const clickedY &#x3D; elementClickedY + initialY;

          pointData &#x3D; {...pointData, initialY, offset, clickedY};
        }

        this.pointData &#x3D; pointData;

        return plotMaker.getPointPosition(this, datum);
      })
      .on(&#x27;drag&#x27;, function(datum: any) {
        const pointData: PointData &#x3D; this.pointData;

        const index &#x3D; datum.i;
        this.newValue &#x3D; plotMaker.getNewValue(this, datum, d3.event);

        if (this.newValue !&#x3D;&#x3D; pointData.lastValue) {
          pointData.lastValue &#x3D; this.newValue;
          const dataChange &#x3D; {trace: pointData.traceIx, axis: &#x27;y&#x27;, index, value: this.newValue};
          plotMaker.onDataChanged &amp;&amp; plotMaker.onDataChanged(dataChange);
        }
      })
      .on(&#x27;dragend&#x27;, function(datum: any) {
        const pointData: PointData &#x3D; this.pointData;

        const documentId &#x3D; plotMaker.documents[datum.i].id;
        const attributeId &#x3D; plotMaker.getAttributeIdForTrace(pointData.traceIx);
        const value &#x3D; this.newValue;

        documentId &amp;&amp;
          attributeId &amp;&amp;
          value &amp;&amp;
          plotMaker.onValueChanged &amp;&amp;
          plotMaker.onValueChanged({documentId, attributeId, value});
      });
  }

  private getInitialValue(traceIx: number, index: number): string | number {
    const attributeId &#x3D; this.getAttributeIdForTrace(traceIx);
    return this.documents[index].data[attributeId];
  }

  private isTraceCategory(index: number): boolean {
    if (index &gt; 0 || !this.config.axes[ChartAxisType.Y1]) {
      return this.isAxisCategory(ChartAxisType.Y2);
    }
    return this.isAxisCategory(ChartAxisType.Y1);
  }

  private getElementOffset(element: Element) {
    const bound &#x3D; element.getBoundingClientRect();
    const html &#x3D; document.documentElement;

    return {
      top: bound.top + window.pageYOffset - html.clientTop,
      left: bound.left + window.pageXOffset - html.clientLeft,
    };
  }

  private getNewValue(point: any, datum: any, event: any): string | number {
    const pointData: PointData &#x3D; point.pointData;

    const newY &#x3D; this.getPointNewY(point, datum, event);
    const newValue &#x3D; pointData.yScale(newY);

    if (pointData.isCategory) {
      return newValue.toString();
    }

    const initialValue &#x3D; pointData.initialValue;
    if (this.isDecimal(+initialValue)) {
      return Number.parseFloat(newValue.toString()).toFixed(2);
    } else {
      return Math.round(+newValue);
    }
  }

  public destroyDrag() {
    this.getPoints().on(&#x27;.drag&#x27;, null);
  }

  protected isNumeric(value: any): boolean {
    return !isNaN(value);
  }

  protected isDecimal(value: number): boolean {
    return value % 1 !&#x3D;&#x3D; 0;
  }
}

export interface PointData {
  traceIx: number;
  yScale: (val: number) &#x3D;&gt; string | number;
  initialValue: string | number;
  lastValue: string | number;
  isCategory: boolean;
  initialY?: number;
  offset?: {top: number; left: number};
  clickedY?: number;
}
</code></pre>
    </div>
</div>






                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'PointData.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <script src="../js/menu-wc.js"></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
